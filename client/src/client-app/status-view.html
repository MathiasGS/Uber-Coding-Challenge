<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">

<dom-module id="status-view">
  <template>
    <iron-ajax id="statusRequest" url="[[apiRequest()]]" handle-as="json" on-response="updateStatus" on-error="requestError" loading="loading"></iron-ajax>

    <template is="dom-if" if="[[status]]">
      <h1>[[status]]</h1>
      <small>[[timestamp]]</small>
    </template>

    <paper-button raised on-tap="home" class="indigo">Send another mail!</paper-button>
  </template>

  <script>
    Polymer({

      is: 'status-view',

      properties: {
        route: Object,
        uuid: String,
        status: String,
        timestamp: Date
      },
      
      ready: function(){
        this.$.statusRequest.generateRequest();
      },

      apiRequest: function(){
        return "/api/v1/status/".concat(this.uuid);
      },

      home: function(){
        this.set("route.path", "");
      },

      updateStatus: function(event){
        this.status = event.detail.response.status;
        this.timestamp = new Date(event.detail.response.timestamp);

        // Repeat request every 5 seconds to poll status update
        if(this.status === "pending"){
          this.async(function() {
            this.$.statusRequest.generateRequest();
          }, 5000);
        }
      },

      requestError: function(){
        this.status = "error fetching status... retrying in 5 seconds.";

        // Retry request in 5 seconds
        this.async(function() {
          this.$.statusRequest.generateRequest();
        }, 5000);
      }
    });
  </script>
</dom-module>